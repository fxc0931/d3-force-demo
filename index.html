<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Force-Directed Graph</title>

    <link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/bootstrap-slider/9.4.1/css/bootstrap-slider.css" rel="stylesheet">



</head>
<body style="text-align: center">
 <svg width="1280" height="600"></svg>

 <br>
<div style="margin: 0 auto">
    <b style="margin-right: 15px">2011</b> <input id="ex1" data-slider-id='ex1Slider' type="text" class="span2" value="2011" data-slider-min="2011"
                                                  data-slider-max="2017" data-slider-step="1" data-slider-value="[2011,2017]"/>
    <b style="margin-left: 10px">2017</b>
</div>


 <script src="https://d3js.org/d3.v5.js"></script>

 <script src="//cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
 <script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
 <script src="//cdn.bootcss.com/bootstrap-slider/9.4.1/bootstrap-slider.min.js"></script>

<script>

    $(document).ready(function(){
        drawGraph()
    })

    // 准备数据
    let nodes = [
        {name:'Nike'},
        {name:'USA'},
        {name:'Apple'},
        {name:'Samsung'},
        {name:'Adidas'},
        {name:'Adidas China'},
        {name:'McDonald'},
        {name:'KFC'},
        {name:'KFC China'},
        {name:'Jack Ma'},
        {name:'Alibaba'},
        {name:'Tencent'},
        {name:'JD.com'},
        {name:'Toyota'},
        {name:'Tesla'},
        {name:'Geely'}
    ]

    let edges = [
        {source:0,target:1,relation:'acquired'},
        {source:2,target:3,relation:'sued'},
        {source:4,target:0,relation:'sued'},
        {source:4,target:5,relation:'decreased stake of'},
        {source:6,target:1,relation:'increased stake of'},
        {source:7,target:8,relation:'decreased stake of'},
        {source:9,target:10,relation:'Is CEO of'},
        {source:11,target:12,relation:'increased stake of'},
        {source:13,target:14,relation:'cooperated with'},
        {source:15,target:14,relation:'acquired'}
    ]
    let data = [
        { year: 2011,
          entityA: 'Nike',
            relation: 'acquired',
          entityB: 'USA'
        },
        { year: 2012,
            entityA: 'Apple',
            relation: 'sued',
            entityB: 'Samsung'
        },
        { year: 2012,
            entityA: 'Adidas',
             relation: 'sued',
            entityB: 'Nike'
        },
        { year: 2014,
            entityA: 'Adidas',
             relation: 'decreased stake of',
            entityB: 'Adidas China'
        },
        { year: 2014,
            entityA: 'McDonald',
             relation: 'increased stake of',
            entityB: 'USA'
        },
        { year: 2015,
            entityA: 'KFC',
             relation: 'decreased stake of',
            entityB: 'KFC China'
        },
        { year: 2015,
            entityA: 'Jack Ma',
             relation: 'Is CEO of',
            entityB: 'Alibaba'
        },
        { year: 2016,
            entityA: 'Tencent',
             relation: 'increased stake of',
            entityB: 'JD.com'
        },
        { year: 2016,
            entityA: 'Toyota',
             relation: 'cooperated with',
            entityB: 'Tesla'
        },
        { year: 2017,
            entityA: 'Geely',
             relation: 'acquired',
            entityB: 'Tesla'
        },

    ]

    let margin = {top: 60,  bottom: 60, left: 60, right: 60}
    let svg = d3.select('svg')
    let width = svg.attr('width')
    let height = svg.attr('height')

    let g = svg.append('g')
        .attr('transform', 'translate('+ margin.top + ',' + margin.left +')')
    // With JQuery
     $('#ex1').slider({
         formatter: function (value) {

             return value
         }
    }).on('slideStop', function (e) {

         nodes = []
         edges = []
         for (let i = 0; i < data.length; i++) {
             if (e.value[0] <= data[i].year && e.value[1] >= data[i].year ) {
                 let itemNode1 = {
                     name: data[i].entityA,
                     relation: data[i]. relation
                 }
                 let itemNode2 = {
                     name: data[i].entityB
                 }
                 nodes.push(itemNode1)
                 nodes.push(itemNode2)
             }
         }
         for (let i = 0; i < nodes.length; i = i + 2) {
             let itemEdge = {
                 source: i,
                 target: i + 1,
                 relation: nodes[i].relation
             }
             edges.push(itemEdge)
         }
         svg.selectAll("svg > *").remove() // 移除svg内部节点
         drawGraph()
     })



    function drawGraph () {
        let margin = {top: 60,  bottom: 60, left: 60, right: 60}
        let svg = d3.select('svg')
        let width = svg.attr('width')
        let height = svg.attr('height')

        let g = svg.append('g')
            .attr('transform', 'translate('+ margin.top + ',' + margin.left +')')

        // 设置color的颜色比例尺，显示不同的颜色
        let colorScale = d3.scaleOrdinal()
            .domain(d3.range(nodes.length))
            .range(d3.schemeCategory10)

        // 新建一个力导向图
        let forceSimulation = d3.forceSimulation()
            .force ('link', d3.forceLink())
            .force('charge', d3.forceManyBody())
            .force('center', d3.forceCenter())


        // 设置图形的属性
        forceSimulation.force('center')
            .x(width/2.3)
            .y(height/2)
        forceSimulation.force('charge')
            .theta(30)
            .distanceMax(300)


        //初始化力导向图
        //生成节点数据
        forceSimulation.nodes(nodes)
            .on('tick',ticked)

        //生成边数据
        forceSimulation.force('link')
            .links(edges)
            .distance(300)


        //绘制边
        let links = g.append('g')
            .selectAll('line')
            .data(edges)
            .enter()
            .append('line')
            .attr('stroke',function(d) {
                return colorScale(d.relation)
            })
            .attr('stroke-width',1.5)

        let linksText = g.append('g')
            .selectAll('text')
            .data(edges)
            .enter()
            .append('text')
            .attr('dx',-30)
            .attr('dy',10)
            .text(function(d){
                return d.relation
            })


        //绘制节点

        var gs = g.selectAll('.circleText')
            .data(nodes)
            .enter()
            .append('g')
            .attr('transform',function(d){
                let cirX = d.x
                let cirY = d.y
                return 'translate('+cirX+','+cirY+')'
            })
            .call(d3.drag()
                .on('start',started)
                .on('drag',dragged)
                .on('end',ended)
            )

        //绘制节点
        gs.append('circle')
            .attr('r',10)
            .attr('fill',function(d,i){
                return colorScale(d.name)
            })

        //文字
        gs.append('text')
            .attr('x',-10)
            .attr('y',-20)
            .attr('dy',10)
            .text(function(d){
                return d.name
            })


        function ticked(){
            links
                .attr('x1',function(d){return d.source.x})
                .attr('y1',function(d){return d.source.y})
                .attr('x2',function(d){return d.target.x})
                .attr('y2',function(d){return d.target.y})

            linksText
                .attr('x',function(d){
                    return (d.source.x+d.target.x)/2
                })
                .attr('y',function(d){
                    return (d.source.y+d.target.y)/2
                })

            gs
                .attr('transform',function(d) { return 'translate(' + d.x + ',' + d.y + ')'  })
        }

        function started(d){
            if(!d3.event.active){
                forceSimulation.alphaTarget(0.8).restart()
            }
            d.fx = d.x
            d.fy = d.y
        }

        function dragged(d){
            d.fx = d3.event.x
            d.fy = d3.event.y
        }

        function ended(d){
            if(!d3.event.active){
                forceSimulation.alphaTarget(0)
            }
            d.fx = null
            d.fy = null
        }
    }



</script>

<style>
    #ex1Slider .slider-selection {
        background: #BABABA;
    }
</style>
</body>
</html>
